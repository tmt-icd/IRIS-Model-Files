subsystem = IRIS
component = imager.pupilview

publish {

  description = """
__TODO__: Define the events of the DETECTOR functional group.
"""

  events = [
    {
      name = MIRROR-state
      description = "Standard assembly state as defiend in [Technical Document: Software Design Patterns for Device and Component Controllers (TMT.INS.TEC.16.079)](https://docushare.tmt.org/docushare/dsweb/Services/Document-57492) plus alpha."
      maxRate = 1
      archive = true
      attributes = [
        {
            name = cmd
            description  = "command state"
            enum = [UNINITIALIZED, READY, BUSY, COTINUOUS]
        }
        {
            name = move
            description  = "state of mechanisms that can move"
            enum = [TRUE, FALSE]
        }
        {
            name = selection
            description  = """
This state attribute indicates where the PV fold mirror is. The meaning of each enum value is as follows:

<ul>
 <li><b>DEPLOYED</b>:  The mirror is in the light path. It is considered deployed when the limit switch on the deployed position is engaged.</li>
 <li><b>RETRACTED</b>: The mirror is outside the light path. It is considered retracted when the limit switch on the retracted position is engaged.</li>
 <li><b>UNKNOWN</b>:   This functional group falls into this state before datuming is completed or when an error is detected.</li>
 <li><b>INTERMEDIATE</b>: After the datuming is completed and if no limit switches are engaged, this functional group falls into this state, which indicates that the mirror is somewhere between the deployed and retracted positions.</li>
</ul>
"""
            enum = [DEPLOYED, RETRACTED, UNKNOWN, INTERMEDIATE]
        }
        {
            name = debug
            description  = "debug level"
            enum = [DEBUG, INFO, WARN, ERROR]
        }
        {
            name = enabled
            description = "indicates whether this functional group is enabled"
            type = boolean
        }
        {
            name = inhibit
            description = "indicates if the inhibit signal to the underlying motion controller is active"
            type = boolean
        }
        {
            name = motion
            enum = [UNDATUMED, DATUMING, DATUMED.IN_POSITION, DATUMED.HALFWAY, MOVING.COARSE, MOVING.PAUSE, MOVING.PUSH, MOVING.RAW, ERROR]
            description  = """
<ul>
 <li><b>UNDATUMED</b>: The status of the mechanism is unknown in this state.  Typically, the stage is stopped, but it may be moving if the motion is on-going when this Assembly is booted.</li>
 <li><b>DATUMING</b>: The mechanism is searching a limit switch.</li>
 <li><b>DATUMED</b>: The stage stays in a known position and the motor current is OFF.
  <ul>
    <li><b>IN_POSITION</b>: The stage is in either deployed or retracted position.</li>
    <li><b>HALFWAY</b>: The stage is somewhere between the deployed and retracted positions.</li>
   </ul>
 </li>
 <li><b>MOVING</b>: The stage is in motion and the current position is known.
  <ul>
   <li><b>COARSE</b>: The stage is in the coarse motion to an either direction.</li>
   <li><b>PAUSE</b>: The stage is temporarily stopped before starting the push motion. The functional group will stay in this state very shortly.</li>
   <li><b>PUSH</b>: The stage is in the final slow push motion to search the limit switch.</li>
  </ul>
 <li><b>ERROR</b>: The status of the mechanism is unknown in this state. Typically, the stage is stopped, but it may be moving, for example, if the user operates the stage in an unusual way (e.g., directly trigger a command in the Web interface of the motion controller).</li>
 </li>
</ul>
"""
        }
        {
            name = errorMsg
            description = "Detailed error messages when 'error' is true. One string element per one active error."
            type = array
            dimensions = [16]
            items = {
              type = string
            }
        }
      ]
    }
    {
      name = MIRROR-cmdStatus
      description = "Standard assembly command status as defiend in [Technical Document: Software Design Patterns for Device and Component Controllers (TMT.INS.TEC.16.079)](https://docushare.tmt.org/docushare/dsweb/Services/Document-57492)."
      maxRate = 1
      archive = true
      attributes = [
        {
            name = command
            description  = "Name of the most recent command."
            type = string
        }
        {
            name = args
            description  = "String representation of the command arguments."
            type = string
        }
        {
            name = caller
            description  = "String identifying the caller (if available)"
            type = string
        }
        {
            name = runID
            description  = "A run ID associated with the command."
            type = integer
        }
        {
            name = ack
            description  = "Initial acknowledgement"
            enum = [ACCEPTED, REJECTED]
        }
        {
            name = ackMsg
            description  = "Acknowledgement string explaining why a command is REJECTED. This string will generally be cleared if the command is ACCEPTED."
            type = string
        }
        {
            name = completion
            description  = "Status of completion"
            enum = [INPROGRESS, SUCCESS, FAILED, INTERRUPTED, REJECTED]
        }
        {
            name = completionMsg
            description  = "The message string is cleared when a command has been successfully acknowledged and/or is INPROGRESS. The message string is filled in if the command fails."
            type = string
        }
      ]
    }
    {
      name = MIRROR-stage
      description = "Current status of the PV fold mirror stage."
      maxRate = 10
      archive = false
      attributes = [
        {
            name  = rawPosition
            description = """
The current raw position reported by the HCD.

This value does not represent the absolute position of the stage. This value will be published only for engineering purposes.
"""
            type  = double
            units = steps
        }
        {
            name  = rawVelocity
            description = """
The current velocity reported by the HCD.

This value does not represent the velocity of the stage, but the rotation velocity of the stepper motor. For example, when the stage is contacting the hard stop, the stage stays in the current position even if this value is non-zero.

This value will be published only for engineering purposes.
"""
            type  = double
            units = step/s
        }
        {
            name  = rawAcceleration
            description = """
The current acceleration reported by the HCD.

This value does not represent the acceleration of the stage, but the rotation acceleration of the stepper motor. For example, when the stage is contacting the hard stop, the stage cannot accelerate even if this value is non-zero.

This value will be published only for engineering purposes.
"""
            type  = double
            units = step/s<sup>2</sup>
        }
        {
            name  = position
            description = """
Estimated current angle from the limit switch of the retracted position. The reported angle may be different from the actual position if the stepper motor experiences misstep or there is misconfiguration.

It becomes NaN when undatumed or datuming.

This value will be published only for engineering purposes.
"""
            type     = double
            units    = deg
            minimum  = 0
            allowNaN = true
        }
        {
            name  = velocity
            description = """
Current commanded velocity of the stage.

This value becomes positive if the stage is moving in the direction of the deployed position.

This value will be published only for engineering purposes.
"""
            type  = double
            units = deg/s
        }
        {
            name  = acceleration
            description = """
Current commanded acceleration of the stage.

This value becomes positive if the stage is accelerating towards the deployed position.

This value will be published only for engineering purposes.
"""
            type  = double
            units = deg/s<sup>2</sup>
        }
        {
            name  = power
            description = "indicates if the stepper motor is powered or not."
            type  = boolean
        }
        {
            name = switches
            description  = "indicates the raw status (on or off) of switches (two limit switches and two position switches)"
            type        = struct
            attributes = [
              {
                name = "deployLimit"
                description = "limit switch of the deployed position"
                type = boolean
              }
              {
                name = "retractLimit"
                description = "limit switch of the retracted position"
                type = boolean
              }
              {
                name = "deployPosition"
                description = "position switch of the deployed position"
                type = boolean
              }
              {
                name = "deployPosition"
                description = "position switch of the retracted position"
                type = boolean
              }
            ]
        }
      ]
    }
  ]

  alarms = [
    {
      name             = DETECTOR-watchdog
      description      = "DETECTOR functional group has become unresponsive"
      severityLevels   = [Major]
      location         = "IRIS Pupil Viewing Mode Assembly (IRIS.imager.pupilview)"
      alarmType        = System
      probableCause    = "Software bug"
      operatorResponse = "Restart the assembly and file a bug report."
      autoAck          = false
      latched          = true
    }
    {
      name             = DETECTOR-unexpectedStatusChange
      description      = "Status of another Assembly changes unexpectedly during the exposure."
      severityLevels   = [Warning]
      location         = "another Assembly"
      alarmType        = System
      probableCause    = "Wrong operation"
      operatorResponse = "Check if the reported status changes are intentional."
      autoAck          = false
      latched          = true
    }

    {
      name             = MIRROR-watchdog
      description      = "MIRROR functional group has become unresponsive"
      severityLevels   = [Major]
      location         = "IRIS Pupil Viewing Mode Assembly (IRIS.imager.pupilview)"
      alarmType        = System
      probableCause    = "Software bug"
      operatorResponse = "Restart the assembly and file a bug report."
      autoAck          = false
      latched          = true
    }
    {
      name             = MIRROR-incompatibleStageConfiguration
      description      = "The stage configuration in the Newport XPS motion controller is not compatible with this Assembly."
      severityLevels   = [Critical]
      location         = "IRIS Pupil Viewing Mode Assembly (IRIS.imager.pupilview)"
      alarmType        = System
      probableCause    = "Misconfiguration"
      operatorResponse = "Reconfigure the stage configuration in the Newport XPS motion controller and reboot it."
      autoAck          = false
      latched          = false
    }
    {
      name             = MIRROR-inconsistentSwitchStatus
      description      = "switch status is inconsistent"
      severityLevels   = [Critical]
      location         = "IRIS Pupil Viewing Mode Assembly (IRIS.imager.pupilview)"
      alarmType        = BitPattern
      probableCause    = "Cable disconnection or malfunction of switches"
      operatorResponse = "Make sure that all relevant cables are connected to the Newport XPS motion controller properly and reboot this Assembly."
      autoAck          = false
      latched          = true
    }
  ]
}
