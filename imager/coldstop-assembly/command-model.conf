subsystem = IRIS
component = imager.coldstop

receive = [
    {
        name = MASK-init
        description = """
This command initializes the MASK functional group and reloads the configuration files. It does not initialize the underlying HCDs, clear the datum, or trigger any motion, but it stops the ongoing motion and/or deenergizes the motor. The existing datum will not be cleared if it is in a normal state.

Preemptable: no
"""
        completionType = longRunning
    }

    {
        name = MASK-datum
        description = """
Start datuming of the rotary stage and precise X and Y linear stages.

Preemptable: yes
"""
        args = [
          {
            name        = skip
            description = "If you do not want to datum a specific stage, specify true to the corresponding boolean element (0: rotary stage, 1: precise X linear stage, 2: precise Y linear stage)."
            type        = array
            dimensions  = [3]
            items = {
              type = boolean
            }
          }
        ]
        preconditions  = ["MASK-state.enabled == false &&",
                          "MASK-state.temperature != HIGH &&",
                          "MASK-state.temperature != UNKNOWN"]
        completionType = longRunning
    }
    {
        name = MASK-disable
        description = """
This command deenergizes the stepper motors of the rotage stage and the precise X and Y linear stages, and disables this functional group. Any commands that may trigger a motion or energize the motors will be rejected when disabled.

This command is expected to be called before starting the cool-down or warm-up procedure.

Preemptable: no
"""
        completionType = longRunning
        postconditions = ["MASK-state.enabled == false"]
    }
    {
        name = MASK-enable
        description = """
This command enables this functional group.

This command is expected to be called after starting the cool-down or warm-up procedure.
"""
        completionType = immediate
        preconditions  = ["MASK-state.enabled == false"]
        postconditions = ["MASK-state.enabled == true"]
    }
    {
        name = MASK-park
        description = "This command does nothing."
        completionType = immediate
    }
    {
        name = MASK-follow
        description = """
Start the tracking motion. TODO: fill out more details.

Preemptable: yes
"""
        completionType = longRunning
        preconditions  = ["MASK-state.enabled == false &&",
                          "MASK-state.temperature != HIGH &&",
                          "MASK-state.temperature != UNKNOWN"]
    }
    {
        name = MASK-move
        description = """
This command moves the rotary stage and the precise X and Y linear stages to given positions.

TODO: define arguments

Preemptable: yes
"""
        requiredArgs = [target]
        args = [
            {
                name = skip
                description = "which stage not move."
                type        = array
                dimensions  = [3]
                items = {
                    type = boolean
                }
            }
        ]
        completionType = longRunning
        preconditions  = ["MASK-state.enabled == true &&",
                          "MASK-state.temperature != HIGH &&",
                          "MASK-state.temperature != UNKNOWN"]
        postconditions = ["MASK-state.move == DATUMED || MASK-state.move == MOVING"]
    }
    {
        name = MASK-stop
        description = """
Stop the motion of the rotary stage and the precise X and Y linear stages.

Preemptable: no
"""
        completionType = longRunning
        postconditions = ["MASK-state.move == DATUMED || MASK-state.move == UNDATUMED"]
    }
    {
        name = MASK-test
        description = "This command executes a self-test. Actual action to be taken is TBD. This command never rotates the rotary stage."
        completionType = immediate
        role = "eng"
    }
    {
        name = MASK-debug
        description = "This will set the current debug level."
        completionType = immediate
        role = "eng"
    }
    {
        name = MASK-setTemperatureThreshold
        description = "Change the overheat protection temperature thresholds."
        completionType = immediate
        requiredArgs = [threshold]
        args = [
            {
                name = skip
                description = "which stage not to change the temperature threshold"
                type        = array
                dimensions  = [3]
                items = {
                    type = boolean
                }
            }
            {
                name = threshold
                description = "New threshold for each rotary stage."
                type = array
                dimensions  = [3]
                items = {
                    type = float
                }
                units = K
                minimum = 0
            }
        ]
        role = "eng"
    }

    {
        name = RETRACT-init
        description = """
This command initializes the RETRACT functional group and reloads the configuration files.  It does not initialize the underlying HCDs, clear the datum, or trigger any motion, but it stops the ongoing motion and deenergizes the motor.

If the stage position is halfway, the datum may be lost as a result of re-initialization.

Preemptable: no
"""
        ref  = imager.adc/receive/RETRACT-init
    }
    {
        name = RETRACT-datum
        description = """
Start datuming the retract stage.

Preemptable: yes
"""
        ref  = imager.adc/receive/RETRACT-datum
    }
    {
        name = RETRACT-select
        description = """
This command inserts the cold stop mask in the science light path or retracts it.

Preemptable: yes
"""
        ref  = imager.adc/receive/RETRACT-select
    }
    {
        name = RETRACT-move
        description = """This command moves the retract stage to an arbitrary position relative to the current position.

Preemptable: yes
"""
        ref  = imager.adc/receive/RETRACT-move
    }
    {
        name = RETRACT-disable
        description = """
This command disables this functional group. Any commands that trigger a motion or turn on the motor current will be rejected when disabled.

This command is expected to be called before starting a cool-down or warm-up procedure.
"""
        ref  = imager.adc/receive/RETRACT-disable
    }
    {
        name = RETRACT-enable
        description = """
This command enables this functional group.

This command is expected to be called after the cool-down or warm-up procedure is completed.
"""
        ref  = imager.adc/receive/RETRACT-enable
    }
    {
        name = RETRACT-park
        description = "This command does nothing."
        ref  = imager.adc/receive/RETRACT-park
    }
    {
        name = RETRACT-stop
        description = """
Stop the motion of the retract stage and turn off the motor power.

Preemptable: no
"""
        ref  = imager.adc/receive/RETRACT-stop
    }
    {
        name = RETRACT-test
        description = "This command executes a self-test. The actual action to be taken is TBD. This command never drives the retract stage."
        ref  = imager.adc/receive/RETRACT-test
    }
    {
        name = RETRACT-debug
        description = "This command sets the current debug level."
        ref  = imager.adc/receive/RETRACT-debug
    }
    {
        name = RETRACT-setTemperatureThreshold
        description = "Change the overheat protection temperature threshold."
        ref  = imager.adc/receive/RETRACT-setTemperatureThreshold
    }

    {
        name = shutdown
        description = "Stop this Assembly. It does not send this command down to the underlying HCDs. The on-going motion may continue after shutdown."
        completionType = longRunning
    }
]
