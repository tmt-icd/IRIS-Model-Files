subsystem = IRIS
component = imager.filter

receive = [
    {
        name = init
        description = """
Initializes this assembly and reloads the configuration files. It does not initialize the underlying HCDs, clear the datum, or trigger any motion, but it stops the ongoing motion and deenergizes the motors.
"""
        completionType = longRunning
    }
    {
        name = datum
        description = "Start datuming of all (or some) filter wheels."
        args = [
          {
            name        = skip
            description = "If you do not want to datum a specific filter wheel, specify true to the corresponding boolean element. The first element coresponds to the filter wheel #1 and the last one corresponds to the filter wheel #5."
            type        = array
            dimensions  = [5]
            items = {
              type = boolean
            }
          }
        ]
        preconditions  = [
                          "state.enabled == false &&",
                          "state.temperature != HIGH &&",
                          "state.temperature != UNKNOWN"
                         ]
        completionType = longRunning
    }
    {
        name = disable
        description = """
This command disables this assembly. Any commands that trigger a motion or turn on the motor current will be rejected when disabled.

This command is expected to be called before starting the cool-down or warm-up procedure.
"""
        completionType = immediate
        preconditions  = [
                          "state.move == false &&",
                          "state.power == false &&",
                          "state.enabled == true"
                         ]
        postconditions = ["state.enabled == false"]
    }
    {
        name = enable
        description = """
This command enables this functional group.

This command is expected to be called after the cool-down or warm-up procedure is completed.
"""
        completionType = immediate
        preconditions  = ["state.enabled == false"]
        postconditions = ["state.enabled == true"]
    }

    {
        name = park
        description = "This command inserts a dark filter in the light path."
        completionType = longRunning
        preconditions  = [
                          "state.enabled == true &&",
                          "state.error == false &&",
                          "state.selection1 != UNKNOWN &&",
                          "state.selection2 != UNKNOWN &&",
                          "state.selection3 != UNKNOWN &&",
                          "state.selection4 != UNKNOWN &&",
                          "state.selection5 != UNKNOWN &&",
                          "state.temperature != HIGH &&",
                          "state.temperature != UNKNOWN"
                          ]
        postconditions = [
                          "state.onTarget == true &&",
                          "state.move == false &&",
                          "state.power == false"
                         ]
    }
    {
        name = select
        description = """
This command changes filters.

This command does not sequence the motion of five wheels. The motion of the five wheels will be triggered at once and they will move in parallel. The direction of rotation is determined by this assembly in a way that the motion time will be minimum.
"""
        args = [
            {
                name = wheel1
                description = "Desired filter in wheel 1."
                enum = [TBD1, TBD2, TBD3, TBD4, TBD5, TBD6, TBD7, TBD8, TBD9, TBD10, TBD11, TBD12, TBD13, TBD14, THROUGH]
            }
            {
                name = wheel2
                description = "Desired filter in wheel 2."
                enum = [TBD1, TBD2, TBD3, TBD4, TBD5, TBD6, TBD7, TBD8, TBD9, TBD10, TBD11, TBD12, TBD13, TBD14, THROUGH]
            }
            {
                name = wheel3
                description = "Desired filter in wheel 3."
                enum = [TBD1, TBD2, TBD3, TBD4, TBD5, TBD6, TBD7, TBD8, TBD9, TBD10, TBD11, TBD12, TBD13, TBD14, THROUGH]    
            }
            {
                name = wheel4
                description = "Desired filter in wheel 4."
                enum = [TBD1, TBD2, TBD3, TBD4, TBD5, TBD6, TBD7, TBD8, TBD9, TBD10, TBD11, TBD12, TBD13, TBD14, THROUGH]
            }
            {
                name = wheel5
                description = "Desired filter in wheel 5."
                enum = [TBD1, TBD2, TBD3, TBD4, TBD5, TBD6, TBD7, TBD8, TBD9, TBD10, TBD11, TBD12, TBD13, TBD14, THROUGH]
            }
        ]
        completionType = longRunning
        preconditions  = [
                          "state.enabled == true &&",
                          "state.error == false &&",
                          "state.selection1 != UNKNOWN &&",
                          "state.selection2 != UNKNOWN &&",
                          "state.selection3 != UNKNOWN &&",
                          "state.selection4 != UNKNOWN &&",
                          "state.selection5 != UNKNOWN &&",
                          "state.temperature != HIGH &&",
                          "state.temperature != UNKNOWN"
                         ]
        postconditions = [
                          "state.onTarget == true &&",
                          "state.move == false &&",
                          "state.power == false"
                         ]
    }
    {
        name = move
        description = "This command moves filter wheels."
        requiredArgs = [target]
        args = [
            {
                name = skip
                description = "which wheel not to move"
                type        = array
                dimensions  = [5]
                items = {
                    type = boolean
                }
            }
            {
                name = target
                description = "Target position."
                type        = array
                dimensions  = [5]
                items = {
                    type = double
                }
                exclusiveMinimum = -Inf
                exclusiveMaximum = Inf
                units = step
            }
            {
                name = relative
                description = "if true, the target position is considered as the position relative to the current position"
                type        = array
                dimensions  = [5]
                items = {
                    type = boolean
                }
                default = false
            }
            {
                name = velocity
                description = "Motion velocity."
                type        = array
                dimensions  = [5]
                items = {
                    type = double
                }
                units = step/s
                exclusiveMinimum = 0
                exclusiveMaximum = Inf
                default = RawMotionVelocity
            }
            {
                name = acceleration
                description = "Motion acceleration."
                type        = array
                dimensions  = [5]
                items = {
                    type = double
                }
                units = step/s<sup>2</sup>
                exclusiveMinimum = 0
                exclusiveMaximum = Inf
                default = RawMotionAcceleration
            }
            {
                name = minimumJerkTime
                description = "Minimum jerk time."
                type        = array
                dimensions  = [5]
                items = {
                    type = double
                }
                units = s
                exclusiveMinimum = 0
                exclusiveMaximum = Inf
                default = RawMotionMinJerkTime
            }
            {
                name = maximumJerkTime
                description = "Maximum jerk time."
                type        = array
                dimensions  = [5]
                items = {
                    type = double
                }
                units = s
                exclusiveMinimum = 0
                exclusiveMaximum = Inf
                default = RawMotionMaxJerkTime
            }
        ]
        completionType = longRunning
        role = "eng"
        preconditions  = [
                          "state.enabled == true &&",
                          "state.temperature != HIGH &&",
                          "state.temperature != UNKNOWN"
                         ]
        postconditions = [
                          "state.move == false &&",
                          "state.power == false"
                         ]
    }
    {
        name = stop
        description = "Stop the motion of all filter wheels and turn off the power of all stepper motors."
        completionType = longRunning
        postconditions = [
                          "state.move == false &&",
                          "state.power == false"
                         ]
    }
    {
        name = test
        description = "This command executes a self-test. Actual action to be taken is TBD. This command never rotates the filter wheels or turn on the motor power."
        completionType = immediate
        role = "eng"
    }
    {
        name = debug
        description = "This will set the current debug level."
        completionType = immediate
        role = "eng"
    }
    {
        name = setTemperatureThreshold
        description = "Change the overheat protection temperature thresholds."
        completionType = immediate
        requiredArgs = [threshold]
        args = [
            {
                name = skip
                description = "which wheel not to change the temperature threshold"
                type        = array
                dimensions  = [5]
                items = {
                    type = boolean
                }
            }
            {
                name = threshold
                description = "New threshold for each wheel."
                type = array
                dimensions  = [5]
                items = {
                    type = float
                }
                units = K
                minimum = 0
            }
        ]
        role = "eng"
    }
    {
        name = shutdown
        description = "Stop this assembly running. It does not send this command down to the underlying HCD(s). The on-going motion may continue after shutdown."
        completionType = longRunning
    }
]
