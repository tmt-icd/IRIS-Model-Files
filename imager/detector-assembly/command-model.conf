subsystem = IRIS
component = imager-detector-assembly

description = """
Imager Detector Assembly Commands.
This command model is based on the recommendation in "Software Design Patterns for Device and Component Controllers" which defines the standard sets of commands, and the command types (request or submit). The commands for component lifecycle defined in [OSW TN013 - Component Lifecycle Design and Implementation (TMT.SFT.TEC.15.006.REL04)](https://docushare.tmt.org/docushare/dsweb/Get/Document-46346/OSW%20TN013-ComponentLifecycleDesign_REL04.pdf) is classified as "lifecycle".
"""

receive = [
    {
        name = INITIALIZE
        requirements = [
            REQ-3-IRIS-SW-0230
            REQ-3-IRIS-SW-0240
        ]
	description = """
This command loads configuration of detectors from Configuration Service or a local file ( __TBD__ ) and store them in the memory. This command never powers up the detector, but purely load configuration.

This command corresponds to 'initialize' message as defined in [OSW TN013 - Component Lifecycle Design and Implementation (TMT.SFT.TEC.15.006.REL04)](https://docushare.tmt.org/docushare/dsweb/Get/Document-46346/OSW%20TN013-ComponentLifecycleDesign_REL04.pdf).

Command type: lifecycle
"""
    }
    {
        name = UNINITIALIZE
        requirements = [
            REQ-3-IRIS-SW-0230
            REQ-3-IRIS-SW-0240
        ]
        description = """
This command basically does nothing.

This command corresponds to 'uninitialize' message as defined in [OSW TN013 - Component Lifecycle Design and Implementation (TMT.SFT.TEC.15.006.REL04)](https://docushare.tmt.org/docushare/dsweb/Get/Document-46346/OSW%20TN013-ComponentLifecycleDesign_REL04.pdf).

Command type: lifecycle
"""
    }
    {
        name = STARTUP
        requirements = [
            REQ-3-IRIS-SW-0230
            REQ-3-IRIS-SW-0240
        ]
        description = """
This command established the connection to detector HCDs of all 4 detectors, and sets up detector controller based on the configuration loaded on INITIALIZE command. This command never powers up the detector.

The execution of this command will fail if not all 4 detector controllers are turned on.

This command corresponds to 'startup' message as defined in [OSW TN013 - Component Lifecycle Design and Implementation (TMT.SFT.TEC.15.006.REL04)](https://docushare.tmt.org/docushare/dsweb/Get/Document-46346/OSW%20TN013-ComponentLifecycleDesign_REL04.pdf).

Command type: lifecycle
"""
    }
    {
        name = SHUTDOWN
        requirements = [
            REQ-3-IRIS-SW-0230
            REQ-3-IRIS-SW-0240
        ]
        description = """
This command cancels on-going exposures and power off all 4 detectors.

This command corresponds to 'shutdown' message as defined in [OSW TN013 - Component Lifecycle Design and Implementation (TMT.SFT.TEC.15.006.REL04)](https://docushare.tmt.org/docushare/dsweb/Get/Document-46346/OSW%20TN013-ComponentLifecycleDesign_REL04.pdf).

Command type: lifecycle
"""
    }
    {
        name = INIT
        description = """
This command reloads static configuration (e.g. number of read channels) of the detectors and the detector controllers. This command can be invoked only when there is no on-going exposure.

Command type: request
"""
    }
    {
        name = TEST
        description = """This command executes a self-test.

__TBD__: Actual actions to be taken is TBD.

Command type: request
"""
    }
    {
        name = START_EXPOSURE
        description = """
This command starts a new exposure with the given cofinguration.

Command type: submit
"""
        requiredArgs = [obsId, reads, subregion]
        args = [
            {
                name = obsId
                description = "Observation ID given by ObserveConfigArg structure as stated in [TMT Software Detailed Design (TMT.SFT.TEC.15.002.REL01)](https://docushare.tmt.org/docushare/dsweb/Get/Document-49912/TMTSoftwareDesign-CSWPD_REL01.pdf)."
                type = string
            }
#####################################################################################################################
# Settings for the number of channels will be moved to configuration as it wouldn't be switched for each observation
#####################################################################################################################
#            {
#                name = channels
#                description  = "Number of channels. The possible numbers are 1, 4, 16, 32, 64."
#                enum = [1, 4, 16, 32, 64]
#                default = 64
#            }
            {
                name = resets
                description = "Number of resets in one ramp."
                type = integer
                minimum = 1
                default = 1
            }
            {
                name = reads
                description = "Number of reads in one group."
                type = integer
                minimum = 1
            }
            {
                name = ramps
                description = "Number of ramps in one exposure."
                type = integer
                minimum = 1
                default = 1
            }
            {
                name = subregion
                description = """
Subregion definition. First index specifies detector number (0 => #1, 1 => #2, 2 => #3, 3 => #4), the second index specifies either left-bottom-most point or right-top-most point (0 => left-bottom-most, 1 => right-top-most) and the third index specifies x or y (0 => x, 1 => y). The coordinate is 0-based including reference pixel.

The diagram below shows the definition of index of this array attribute.

![Subregion definition](http://irisj-sde1.mtk.nao.ac.jp:8081/icddb_images.git/raw/master/imager/detector-assembly/subregion_definition.png)

__TBD__: Check if subregion (or subraster) reading is required. If so, some synchronization scheme among four detectors is required for the case different subregion size is set.
"""
                type = array
                dimensions = [4,2,2]
                items = {
                    type = integer
                    minimum = 0
                    maximum = 4095
                }
                units = pixel
            }
        ]
    }
    {
        name = ABORT_EXPOSURE
        description = """
This command aborts the current exposure.

Command type: submit
"""
    }
    {
        name = LOCK
        description = """
This command locks all 4 detectors from starting detector clocking and taking exposures. This command will be used in Warm Stow use case as mentioned in [IRIS Software Design Document (TMT.INS.PDD.14.024.DRF07)](https://docushare.tmt.org/docushare/dsweb/Get/Document-32613/160210_IRIS_SDD_DRF07.docx).

__DISCUSSION__: How can we technically lock the detectors? One possible approach is to turn off detector controller.

Command type: submit
"""
    }
    {
        name = UNLOCK
        description = """
This command unlocks all 4 detectors so that the detector can be powered up. This command will be used in Activate and Warm Activate use cases as mentioned in [IRIS Software Design Document (TMT.INS.PDD.14.024.DRF07)](https://docushare.tmt.org/docushare/dsweb/Get/Document-32613/160210_IRIS_SDD_DRF07.docx).

Command type: submit
"""
    }
    {
        name = POWER_ON
        description = """This command turns on power of all 4 detectors. This command will be used in Warm Stow use case as mentioned in [IRIS Software Design Document (TMT.INS.PDD.14.024.DRF07)](https://docushare.tmt.org/docushare/dsweb/Get/Document-32613/160210_IRIS_SDD_DRF07.docx).

Command type: request
"""
    }
    {
        name = POWER_OFF
        description = """
This command turns off power of all 4 detectors. This command will be used in Activate and Warm Activate use cases as mentioned in [IRIS Software Design Document (TMT.INS.PDD.14.024.DRF07)](https://docushare.tmt.org/docushare/dsweb/Get/Document-32613/160210_IRIS_SDD_DRF07.docx).

Command type: request
"""
    }
]
