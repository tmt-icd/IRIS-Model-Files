subsystem = IRIS
component = imager.detector

receive = [
    {
        name = init
        description = """
Initializes this assembly and reloads the configuration files. It does not intialize the underlying HCDs, trigger any exposure or initiate any action on the hardware.
"""
        completionType = longRunning
    }
    {
        name           = test
        description    = """
This command executes a self-test. Action to be taken is TBD.

This command never starts an exposure nor reset the detectors.
"""
        completionType = immediate
        role           = "eng"
    }
    {
        name = loadConfiguration
        description = """
This command validates the given specified exposure configuration and saves them internally in this Assembly, the underlying Detector HCD and/or the detector controllers so that the next exposure will be performed with the specified configuration.
"""
        requiredArgs = [obsId, exposureNumber, rampIntegrationTime]
        args = [
            {
                name = obsId
                description = "Observation ID given by ObserveConfigArg structure as stated in [TMT Software Detailed Design (TMT.SFT.TEC.15.002.REL01)](https://docushare.tmt.org/docushare/dsweb/Get/Document-58152/CSWDetailedDesign-CSWFD_REL02_signed.pdf)."
                type = string
            }
            {
                name = rampIntegrationTime
                description = "Integration time for one ramp. The specified value will be rounded down to the nearest valid integration time so that it will be a multiple of readout time. The definition of the ramp integration time is the time between resets."
                type = integer
                exclusiveMinimum = 0
                units = ms
            }
            {
                name = ramps
                description = "The number of ramps in one exposure."
                type = integer
                minimum = 1
                default = 1
            }
            {
                name = samplingMode
                description = "Sampling mode."
                enum = [MCDS, UTR]
                default = UTR
            }
            {
                name = coadd
                description = "Number of coadds for MCDS. If it is one, the sampling mode is effectively the same as CDS."
                type = integer
                default = 1
            }
        ]
        preconditions  = ["state.cmd = READY"]
        postconditions = ["exposureConf.loaded = TRUE"]
        completionType = longRunning
    }
    {
        name = startExposure
        description = """
This command starts a new exposure with the pre-loaded configuration. This command is considered completed when the specified exposure time has been elapsed and all the intermediate raw science frames are successfully saved in Readout Disk.
"""
        preconditions  = ["state.cmd           = READY &&",
                          "state.sleep         = FALSE &&",
                          "exposureConf.loaded = TRUE  &&",
                          "(staticConf.detector1.use = FALSE || perDetectorState.detector1.power = TRUE) &&",
                          "(staticConf.detector2.use = FALSE || perDetectorState.detector2.power = TRUE) &&",
                          "(staticConf.detector3.use = FALSE || perDetectorState.detector3.power = TRUE) &&",
                          "(staticConf.detector4.use = FALSE || perDetectorState.detector4.power = TRUE) &&"]
        postconditions = ["state.cmd = CONTINUOUS"]
        completionType = longRunning
    }
    {
        name = abortExposure
        description = "Cancels the exposure in progress."
        preconditions  = ["state.cmd = CONTINUOUS"]
        postconditions = ["state.cmd = READY"]
        completionType = longRunning
    }
    {
        name = datum
        description = "TBD"
        completionType = immediate
    }
    {
        name = park
        description = "TBD"
        completionType = immediate
    }
    {
        name = disable
        description = """
This command disables this assembly. Any commands that triggers a new exposure will be rejected when disabled.

This command is expected to be called before starting the cool-down or warm-up procedure.
"""
        completionType = immediate
        preconditions  = [
                          "state.exposure == ",
                          "state.power == false",
                          "state.enabled == true"
                         ]
        postconditions = ["state.enabled == false"]
    }
    {
        name = enable
        description = """
This command enables this assembly.

This command is expected to be called after the cool-down or warm-up procedure is completed.
"""
        completionType = immediate
        preconditions  = ["state.enabled == false"]
        postconditions = ["state.enabled == true"]
    }
    {
      name           = debug
        description = "Set the debug level."
      completionType = immediate
      role           = "eng"
    }
    {
        name = shutdown
        description = "Shutdown this assembly. It does not send this command down to the underlying HCDs. The ongoing exposure may continue after shutdown."
        completionType = immediate
    }
]
