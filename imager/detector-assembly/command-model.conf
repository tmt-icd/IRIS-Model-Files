subsystem = IRIS
component = imager.detector

receive = [
    {
        name = init
        description = """
This command causes this functional group to initialize its internal variables and read configuration. It is internally called as a part of lifecycle initialization. It does not trigger any readout or reset on the detectors.
"""
        preconditions  = ["state.cmd = UNINITIALIZED ||",
                          "state.cmd = READY"]
        postconditions = ["state.cmd           = READY &&",
                          "state.sleep         = TRUE &&",
                          "exposureConf.loaded = FALSE"]
        completionType = immediate
    }
    {
        name = test
        description = """
This command executes a self-test. Action to be taken is TBD.

This command never starts an exposure nor reset the detectors.
"""
        preconditions  = ["state.cmd = READY"]
        completionType = immediate
    }
    {
        name = loadConfiguration
        description = """
This command validates the given specified exposure configuration and saves them internally in this Assembly, the underlying Detector HCD and/or the detector controllers so that the next exposure will be performed with the specified configuration.
"""
        requiredArgs = [obsId, exposureNumber, rampIntegrationTime]
        args = [
            {
                name = obsId
                description = "Observation ID given by ObserveConfigArg structure as stated in [TMT Software Detailed Design (TMT.SFT.TEC.15.002.REL01)](https://docushare.tmt.org/docushare/dsweb/Get/Document-58152/CSWDetailedDesign-CSWFD_REL02_signed.pdf)."
                type = string
            }
            {
                name = rampIntegrationTime
                description = "Integration time for one ramp. The specified value will be rounded down to the nearest valid integration time so that it will be a multiple of readout time. The definition of the ramp integration time is the time between resets."
                type = integer
                exclusiveMinimum = 0
                units = ms
            }
            {
                name = ramps
                description = "The number of ramps in one exposure."
                type = integer
                minimum = 1
                default = 1
            }
            {
                name = samplingMode
                description = "Sampling mode."
                enum = [MCDS, UTR]
                default = UTR
            }
            {
                name = coadd
                description = "Number of coadds for MCDS. If it is one, the sampling mode is effectively the same as CDS."
                type = integer
                default = 1
            }
        ]
        preconditions  = ["state.cmd = READY"]
        postconditions = ["exposureConf.loaded = TRUE"]
        completionType = longRunning
    }
    {
        name = startExposure
        description = """
This command starts a new exposure with the pre-loaded configuration. This command is considered completed when the specified exposure time has been elapsed and all the intermediate raw science frames are successfully saved in Readout Disk.

Command type: exposure
"""
        preconditions  = ["state.cmd           = READY &&",
                          "state.sleep         = FALSE &&",
                          "exposureConf.loaded = TRUE  &&",
                          "(staticConf.detector1.use = FALSE || perDetectorState.detector1.power = TRUE) &&",
                          "(staticConf.detector2.use = FALSE || perDetectorState.detector2.power = TRUE) &&",
                          "(staticConf.detector3.use = FALSE || perDetectorState.detector3.power = TRUE) &&",
                          "(staticConf.detector4.use = FALSE || perDetectorState.detector4.power = TRUE) &&"]
        postconditions = ["state.cmd = CONTINUOUS"]
        completionType = longRunning
    }
    {
        name = abortExposure
        description = """
This command cancels the current exposure in progress before the specified exposure time is elapsed.
"""
        preconditions  = ["state.cmd = CONTINUOUS"]
        postconditions = ["state.cmd = READY"]
        completionType = longRunning
    }
    {
        name = datum
        description = "TBD"
        completionType = immediate
    }
    {
        name = park
        description = "TBD"
        completionType = immediate
    }
    {
        name = disable
        description = """
This command disables this assembly. Any commands that trigger a new exposure will be rejected when disabled.

This command is expected to be called before starting the cool-down or warm-up procedure.
"""
        completionType = immediate
        preconditions  = [
                          "state.move == false",
                          "state.power == false",
                          "state.enabled == true"
                         ]
        postconditions = ["state.enabled == false"]
    }
    {
        name = sleep
        description = """
This command puts this functional to sleep. Any command that turns on the power or triggers a new exposure will be rejected when sleeping.

This command is expected to be called before starting the instrument cool-down or warm-up procedure.
"""
        preconditions  = ["state.cmd   = READY &&",
                          "perDetectorState.detector1.power = FALSE &&",
                          "perDetectorState.detector2.power = FALSE &&",
                          "perDetectorState.detector3.power = FALSE &&",
                          "perDetectorState.detector4.power = FALSE &&",
                          "state.sleep = FALSE"]
        postconditions = ["state.sleep = TRUE"]
        completionType = immediate
    }
    {
        name = wakeup
        description = """
This command wakes up this functional group.

This command is expected to be called atter the completion of instrument cool-down or warm-up procedure.
"""
        preconditions  = ["state.cmd   = READY &&",
                          "state.sleep = TRUE"]
        postconditions = ["state.sleep = FALSE"]
        completionType = immediate
    }
    {
      name = debug
      description = "Change logging levels for this component only. It is purely for debugging purposes."
      completionType = immediate      
    }
    {
        name = shutdown
        description = """
It is internally called as a part of the lifecycle shutdown. It does not send this command down to the underlying HCDs.
"""
        completionType = immediate
    }
]
