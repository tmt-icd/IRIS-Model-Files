subsystem = IRIS
component = imager.adc

publish {

  events = [
     {
        name = odgwShift
        description = """
IRIS publishes the expected shifts of the ODGW guide star positions.

<em>
Discussion: The Science ADC will shift ideal guide star positions in a manner that depends upon the current angles of the ADC prisms. Since the ODGW guide stars are viewed through the Science ADC, any telescope pointing shifts based on the sciShift event published by this Assembly should also remove shifts in the ODGW positions. However, the Science ADC causes elevation distortion on the image, which is a high-order distortion that cannot be corrected by NFIRAOS. The distortion can be seen as shifts of the ODGW guide star positions. The shift amount of each guide star depends on the power angle of Science ADC and where the guide star is within the IRIS Imager FoV. This published event can be used by the TCS to make small adjustments to the ODGW guide star position demands for this distortion.
</em>

<em>
Discussion: It is believed that the distortion amount does not depend on the wavelength.
</em>
        """
        maxRate = 20
        archive = true
        attributes = [
            {
                name = odgw1Shift
                description  = "2 element array holding x, y values (range TBD) in the FCRS<sub>IRIS-ROT</sub>, evaluated at the reference wavelength"
                type = array
                dimensions: [2]
                items = {
                    type = double
                    units = mm
                }
            }
            {
                name = odgw2Shift
                description  = "2 element array holding x, y values (range TBD) in the FCRS<sub>IRIS-ROT</sub>, evaluated at the reference wavelength"
                type = array
                dimensions: [2]
                items = {
                    type = double
                    units = mm
                }
            }
            {
                name = odgw3Shift
                description  = "2 element array holding x, y values (range TBD) in the FCRS<sub>IRIS-ROT</sub>, evaluated at the reference wavelength"
                type = array
                dimensions: [2]
                items = {
                    type = double
                    units = mm
                }
            }
            {
                name = odgw4Shift
                description  = "2 element array holding x, y values (range TBD) in the FCRS<sub>IRIS-ROT</sub>, evaluated at the reference wavelength"
                type = array
                dimensions: [2]
                items = {
                    type = double
                    units = mm
                }
            }
            {
              name          = odgw_trackID
              description   = "Unique TCS target ID that is incremented (with rollover) each time the TCS is instructed to move to a new target, for each of the four ODGWs"
              type          = array
              dimensions: [4]
              items = {
                type        = long
              }
            }
            {
                name          = timestamp
                description   = "Time when valid (units and epoch are TBD)"
                units         = mjd
                type          = long
            }
        ]
     }

    {
        name = sciShift
        description = """
IRIS publishes the expected ADC image shift of the scient target.

*Discussion: The ADC will shift an image position in a manner that depends upon the current state of the ADC. The estimated image shift (inferred from optical models) is sent from IRIS to the TCS so that the TCS can adjust the telescope pointing, thereby stabilizing the science target on the IRIS imager. The reference wavelength used to calculate the shift is tcs.cm.iris.imgCurAtmDispersion.referenceWavelength.*
        """
        archive = true
        attributes = [
            {
                name = shift
                description  = "2 element array holding x, y values (range TBD) in the FCRS<sub>IRIS-ROT</sub>, evaluated at the reference wavelength"
                type = array
                dimensions: [2]
                items = {
                    type = double
                    units = mm
                }
            }
            {
                name          = timestamp
                description   = "Time when valid (units and epoch are TBD)"
                units         = mjd
                type          = long
            }
            {
                name          = trackID
                description   = "Unique TCS target ID that is incremented (with rollover) each time the TCS is instructed to move to a new target."
                type          = long
            }
        ]
    }

    {
        name = PRISM-target
        description = """
Target positions of the ADC prisms and 

This event can be used to correct the distortion that will be introduced by the Science ADC.

This event is published when the Science ADC is inserted into or retracted from the light path, and continuously published in the tracking mode.

All angles in this event are defined in the XY plane in the FCRS<sub>IRIS-ROT</sub>, and measured from the X axis in the counterclockwise direction looking towards the negative Z direction of the FCRS<sub>IRIR-ROT</sub>.

This event is intended to be subscribed by the AO system to correct the pupil displacement and the linear distortion introduced by this Science ADC.

This event may be also subscribed by the TCS to check if the Science ADC keeps in phase with the telescope.
"""
        archive = true
        attributes = [
            {
                name        = p1Angle
                description = "Angle of the dispersion axis of the P1 prism pairs. $` \\alpha_1 `$"
                type        = double
                units       = degree
            }
            {
                name        = p2Angle
                description = "Angle of the dispersion axis of the P2 prism pairs. $` \\alpha_2 `$"
                type        = double
                units       = degree
            }
            {
                name        = powerAngle
                description = "Power angle. $` \\alpha_{\\rm PW} = \\frac{ \\alpha_1 - \\alpha_2 }{2}`$"
                type        = double
                units       = degree
            }
            {
                name        = dispersionAxisAngle
                description = "Angle of the synthesized dispersion axis. $` \\alpha_{\\rm DA} = \\frac{ \\alpha_1 + \\alpha_2 }{2} `$"
                type        = double
                units       = degree
            }
            {
                name          = timestamp
                description   = "Time when valid (units and epoch are TBD)"
                units         = mjd
                type          = long
            }
            {
                name          = trackID
                description   = "Unique TCS target ID that is incremented (with rollover) each time the TCS is instructed to move to a new target."
                type          = long
            }
        ]
    }
    {
        name = PRISM-current
        description = """
Current positions of the rotary stages.

All angles in this event are defined in the XY plane in the FCRS<sub>IRIS-ROT</sub>, and measured from the X axis in the counterclockwise direction looking towards the negative Z direction of the FCRS<sub>IRIR-ROT</sub>.

All attributes in this event become NaN if one of the rotary stages is undatumed or datuming.
"""
        archive = true
        attributes = [
            {
                name             = p1Angle
                description      = "Angle of the dispersion axis of the P1 prism pairs. $` \\alpha_1 `$"
                type             = double
                units            = degree
                minimum          = 0
                exclusiveMaximum = 360
                allowNaN         = true
            }
            {
                name             = p2Angle
                description      = "Angle of the dispersion axis of the P2 prism pairs. $` \\alpha_2 `$"
                type             = double
                units            = degree
                minimum          = 0
                exclusiveMaximum = 360
                allowNaN         = true
            }
            {
                name             = p1AngleError
                description      = "Error of the P1 rotary stage angle."
                type             = double
                units            = degree
                exclusiveMinimum = -Inf
                exclusiveMaximum = Inf
                allowNaN         = true
            }
            {
                name             = p2AngleError
                description      = "Error of the P2 rotary stage angle."
                type             = double
                units            = degree
                exclusiveMinimum = -Inf
                exclusiveMaximum = Inf
                allowNaN         = true
            }
            {
                name             = powerAngle
                description      = "Power angle. $` \\alpha_{\\rm PW} = \\frac{ \\alpha_1 - \\alpha_2 }{2}`$"
                type             = double
                units            = degree
                minimum          = 0
                maximum          = 90
                allowNaN         = true
            }
            {
                name        = dispersionAxisAngle
                description = "Angle of the synthesized dispersion axis. $` \\alpha_{\\rm DA} = \\frac{ \\alpha_1 + \\alpha_2 }{2} `$"
                type             = double
                units            = degree
                minimum          = 0
                exclusiveMaximum = 360
                allowNaN         = true
            }
        ]
    }

    {
      name = PRISM-state
      description = "Standard fundtional group state as defiend in [Technical Document: Software Design Patterns for Device and Component Controllers (TMT.INS.TEC.16.079)](https://docushare.tmt.org/docushare/dsweb/Services/Document-57492) plus alpha."
      maxRate = 1
      archive = true
      attributes = [
        {
            name = cmd
            description  = "command state"
            enum = [UNINITIALIZED, READY, BUSY]
        }
        {
            name = move
            description  = "state of mechanisms that can move"
            enum = [UNDATUMED, DATUMING, DATUMED, MOVING, UNKNOWN]
        }
        {
            name = debug
            description  = "debug level"
            enum = [DEBUG, INFO, WARN, ERROR]
        }
        {
            name = enabled
            description = "indicates whether this functional group is enabled"
            type = boolean
        }
        {
            name = interlock
            description = "indicates if an interlock is asserted by the Safety HCD"
            type = boolean
        }
        {
            name = inhibit
            description = "indicates if the inhibit signal to the underlying motion controller(s) is active"
            type = boolean
        }
        {
            name  = power
            description = "indicates if the stepper motors are powered or not."
            type  = boolean
        }
        {
            name = error
            description  = "indicates if one or more errors present."
            type = boolean
        }
        {
            name = errorMsg
            description = "Detailed error messages when 'error' is true. One string element per one active error."
            type = array
            dimensions = [16]
            items = {
              type = string
            }
        }
      ]
    }
    {
      name = PRISM-cmdStatus
      description = "Standard command status of this functional group."
      archive = true
      ref = imager.shutter/events/cmdStatus
    }

    {
      name = PRISM-p1
      description = "Current status of the P1 rotary stage."
      maxRate = 1
      archive = false
      attributes = [
        {
            name = cmd
            description  = "command state"
            enum = [UNINITIALIZED, READY, BUSY]
        }
        {
            name = onTarget
            description = "whether the rotary stages are on the target position"
            type = boolean
        }
        {
            name = move
            description  = "state of mechanism that can move"
            enum = [UNDATUMED, DATUMING, DATUMED, MOVING, UNKONWN]
        }
        {
            name  = power
            description = "indicates if the stepper motor is powered or not."
            type  = boolean
        }
        {
            name = inhibit
            description = "indicates if the inhibit signal to the underlying motion controller is active"
            type = boolean
        }
        {
            name = enabled
            description = "indicates if this rotary stage is enabled"
            type = boolean
        }
        {
            name = error
            description  = "indicates if one or more errors present."
            type = boolean
        }
        {
            name = errorMsg
            description = "Detailed error messages when 'error' is true. One string element per one active error."
            type = array
            dimensions = [16]
            items = {
              type = string
            }
        }
      ]
    }
    {
      name = PRISM-p1Motion
      description = "Motion status of the P1 rotary stage."
      maxRate = 20
      archive = false
      attributes = [
        {
            name = onTarget
            description  = "whether the rotary stage is on the target position or not"
            type = boolean
        }
        {
            name  = rawPosition
            description = """
The raw position reported by the HCD.

This value does not always represent the absolute position of the rotary stage. This can be a meaningless value when datuming. This value will be published only for engineering purposes.
"""
            type  = double
            units = steps
        }
        {
            name  = rawPositionError
            description = "The raw position error reported by the HCD. This value will be published only for engineering purposes."
            type  = double
            units = steps
        }
        {
            name  = position
            description = """
The estimated angle of the rotary stage from the datum in the counterclockwise direction viewing from the top.

It becomes NaN when undatumed or datuming.

This value will be published only for engineering purposes.
"""
            type     = double
            units    = degree
            allowNaN = true
            minimum = 0
            exclusiveMaximum = 360
        }
        {
            name  = positionError
            description = """
The estimated angle error of the rotary stage.

It becomes NaN when undatumed or datuming.

This value will be published only for engineering purposes.
"""
            type     = double
            units    = degree
            allowNaN = true
            minimum = 0
            exclusiveMaximum = 360
        }
        {
            name  = velocity
            description = """
Velocity of the stage.

This value becomes positive if the rotary stage is rotating in the counterclockwise direction.

This value will be published only for engineering purposes.
"""
            type  = double
            units = deg/s
        }
        {
            name  = acceleration
            description = """
Acceleration of the stage.

This value becomes positive if the rotary stage is accelerating towards the counterclockwise direction.

This value will be published only for engineering purposes.
"""
            type  = double
            units = deg/s<sup>2</sup>
        }
        {
            name  = targetPosition
            description = """
The target angle of the current motion if a motion is ongoing, or that of the previous motion if a motion is not ongoing. The definition of the angle is the same as the "position" attribute.

It becomes NaN when initialized.

This value will be published only for engineering purposes.
"""
            type     = double
            units    = degree
            allowNaN = true
            minimum = 0
            exclusiveMaximum = 360
        }
        {
          name          = timestamp
          description   = "Best guess of the time when the position was sampled (units and epoch are TBD)"
          units         = mjd
          type          = long
        }
        {
          name          = timestampLowerBoundary
          description   = "Lower boundary of the confidence interval of the timestamp. The definition of the confident level is TBD."
          units         = second
          maximum       = 0
          type          = double
        }
        {
          name          = timestampUpperBoundary
          description   = "Upper boundary of the confidence interval of the timestamp. The definition of the confident level is TBD."
          units         = second
          minimum       = 0
          type          = double
        }
      ]
    }
    {
      name = PRISM-p1Target
      description = "Target position of the P1 rotary stage. This event is expected to be subscribed by the underlying Newport HCD."
      archive = false
      attributes = [
        {
            name         = target
            description  = "Target position of the P1 rotary stage"
            units        = steps
            type         = double
        }
        {
            name          = timestamp
            description   = "Time when valid (units and epoch are TBD)"
            units         = mjd
            type          = long
        }
      ]
    }


    {
      name = PRISM-p2
      description = "Current status of the P2 rotary stage."
      ref = PRISM-p1
    }
    {
      name = PRISM-p2Motion
      description = "Motion status of the P2 rotary stage."
      ref = PRISM-p1Motion
    }
    {
      name = PRISM-p2Target
      description = "Target position of the P2 rotary stage. This event is expected to be subscribed by the underlying Newport HCD."
      ref  = PRISM-p1Target
    }

    {
      name = RETRACT-state
      description = "Standard functional group state as defiend in [Technical Document: Software Design Patterns for Device and Component Controllers (TMT.INS.TEC.16.079)](https://docushare.tmt.org/docushare/dsweb/Services/Document-57492) plus alpha."
      maxRate = 1
      archive = true
      attributes = [
        {
            name = cmd
            description  = "command state"
            enum = [UNINITIALIZED, READY, BUSY]
        }
        {
            name = move
            description  = "state of mechanisms that can move"
            enum = [TRUE, FALSE]
        }
        {
            name = selection
            description  = """
This state attribute indicates where the retract stage is. The meaning of each enum value is as follows:

<ul>
 <li><b>DEPLOYED</b>:  The ADC prisms are in the light path. It is considered deployed when the limit switch on the deployed position is engaged.</li>
 <li><b>RETRACTED</b>: The ADC prisms are retracted from the light path. It is considered retracted when the limit switch on the retracted position is engaged.</li>
 <li><b>UNKNOWN</b>:   This functional group falls into this state before datuming is completed or when an error is detected.</li>
 <li><b>INTERMEDIATE</b>: After the datuming is completed and if no limit switches are engaged, this functional group falls into this state, which indicates that the ADC prisms are somewhere between the deployed and retracted positions.</li>
</ul>
"""
            enum = [DEPLOYED, RETRACTED, UNKNOWN, INTERMEDIATE]
        }
        {
            name = debug
            description  = "debug level"
            enum = [DEBUG, INFO, WARN, ERROR]
        }
        {
            name = enabled
            description = "indicates whether this functional group is enabled"
            type = boolean
        }
        {
            name = interlock
            description = "indicates if an interlock is asserted by the Safety HCD"
            type = boolean
        }
        {
            name = inhibit
            description = "indicates if the inhibit signal to the underlying motion controller is active"
            type = boolean
        }
        {
            name  = power
            description = "indicates if the stepper motor is powered or not."
            type  = boolean
        }
        {
            name = motion
            enum = [UNDATUMED, DATUMING, DATUMED.IN_POSITION, DATUMED.HALFWAY, MOVING.COARSE, MOVING.PAUSE, MOVING.PUSH, MOVING.RAW, ERROR]
            description  = """
<ul>
 <li><b>UNDATUMED</b>: The status of the mechanism is unknown in this state.  Typically, the stage is stopped, but it may be moving if the motion is on-going when this Assembly is booted.</li>
 <li><b>DATUMING</b>: The mechanism is searching a limit switch.</li>
 <li><b>DATUMED</b>: The stage is staying in a known position and the motor current is OFF.
  <ul>
    <li><b>IN_POSITION</b>: The stage is in either deployed or retracted position.</li>
    <li><b>HALFWAY</b>: The stage is somewhere between the deployed and retracted positions.</li>
   </ul>
 </li>
 <li><b>MOVING</b>: The stage is in motion and the current position is known.
  <ul>
   <li><b>COARSE</b>: The stage is in the coarse motion in either direction.</li>
   <li><b>PAUSE</b>: The stage is temporarily stopped before starting the push motion. The functional group will stay in this state very shortly.</li>
   <li><b>PUSH</b>: The stage is in the final slow push motion to search the limit switch.</li>
  </ul>
 <li><b>ERROR</b>: The status of the mechanism is unknown in this state. Typically, the stage is stopped in this state. But, it may be moving, for example, if the user operates the stage in an unusual way (e.g., directly trigger a command in the Web interface of the motion controller).</li>
 </li>
</ul>
"""
        }
        {
            name = error
            description  = "indicates if one or more errors present."
            type = boolean
        }
        {
            name = errorMsg
            description = "Detailed error messages when 'error' is true. One string element per one active error."
            type = array
            dimensions = [16]
            items = {
              type = string
            }
        }
      ]
    }
    {
      name = RETRACT-cmdStatus
      description = "Standard command status of this functional group."
      archive = true
      ref = imager.shutter/events/cmdStatus
    }
    {
      name = RETRACT-stage
      description = "Current status of the retract stage."
      maxRate = 10
      archive = false
      attributes = [
        {
            name  = rawPosition
            description = """
The current raw position reported by the HCD.

This value does not represent the absolute position of the stage. This value will be published only for engineering purposes.
"""
            type  = double
            units = steps
        }
        {
            name  = rawVelocity
            description = """
The current velocity reported by the HCD.

This value does not represent the velocity of the stage, but the rotation velocity of the stepper motor. For example, when the stage is contacting the hard stop, the stage stays in the current position even if this value is non-zero.

This value will be published only for engineering purposes.
"""
            type  = double
            units = step/s
        }
        {
            name  = rawAcceleration
            description = """
The current acceleration reported by the HCD.

This value does not represent the acceleration of the stage, but the rotation acceleration of the stepper motor. For example, when the stage is contacting the hard stop, the stage cannot accelerate even if this value is non-zero.

This value will be published only for engineering purposes.
"""
            type  = double
            units = step/s<sup>2</sup>
        }
        {
            name  = position
            description = """
Estimated current angle from the limit switch of the retracted position. The reported angle may be different from the actual position if the stepper motor experiences misstep or there is misconfiguration.

It becomes NaN when undatumed or datuming.

This value will be published only for engineering purposes.
"""
            type     = double
            units    = mm
            minimum  = 0
            allowNaN = true
        }
        {
            name  = velocity
            description = """
Current commanded velocity of the stage.

This value becomes positive if the stage is moving in the direction of the deployed position.

This value will be published only for engineering purposes.
"""
            type  = double
            units = mm/s
        }
        {
            name  = acceleration
            description = """
Current commanded acceleration of the stage.

This value becomes positive if the stage is accelerating towards the deployed position.

This value will be published only for engineering purposes.
"""
            type  = double
            units = mm/s<sup>2</sup>
        }
        {
            name = switches
            description  = "indicates the raw status (on or off) of switches (two limit switches and one position switch)"
            type        = struct
            attributes = [
              {
                name = "deployLimit"
                description = "limit switch of the deployed position"
                type = boolean
              }
              {
                name = "retractLimit"
                description = "limit switch of the retracted position"
                type = boolean
              }
              {
                name = "deployPosition"
                description = """position switch of the deployed position

NOTE: It is not guaranteed that the prisms are in the light path even if this attribute is true.
"""
                type = boolean
              }
            ]
        }
      ]
    }
  ]

  alarms = [
    {
      name             = PRISM-watchdog
      description      = "The PRISM functional group is unresponsive."
      severityLevels   = [Major]
      location         = "IRIS Science ADC Assembly (IRIS.imager.adc)"
      alarmType        = System
      probableCause    = "Software bug"
      operatorResponse = "Restart the assembly and file a bug report."
      autoAck          = false
      latched          = true
    }
    {
      name             = PRISM-incompatibleStageConfiguration
      description      = "The stage configuration for the rotary stages in the Newport XPS motion controller is not compatible with this functional group."
      severityLevels   = [Warning, Major, Critical]
      location         = "IRIS Science ADC Assembly (IRIS.imager.adc)"
      alarmType        = System
      probableCause    = "Misconfiguration"
      operatorResponse = "Reconfigure the stage configuration in the Newport XPS motion controller and reboot it."
      autoAck          = false
      latched          = false
    }
    {
      name             = PRISM-p1InconsistentSensorStatus
      description      = "Sensor status of the rotary stage P1 is inconsistent."
      severityLevels   = [Critical]
      location         = "IRIS Science ADC Assembly (IRIS.imager.adc)"
      alarmType        = BitPattern
      probableCause    = "Cable disconnection, or malfunction of the hall sensor or the hall sensor readout electronics."
      operatorResponse = "Make sure that all relevant cables are connected to the Newport XPS motion controller properly and reboot this Assembly."
      autoAck          = false
      latched          = true
    }
    {
      name             = PRISM-p2InconsistentSensorStatus
      description      = "Sensor status of the rotary stage P2 is inconsistent."
      severityLevels   = [Critical]
      location         = "IRIS Science ADC Assembly (IRIS.imager.adc)"
      alarmType        = BitPattern
      probableCause    = "Cable disconnection, or malfunction of the hall sensor or the hall sensor readout electronics."
      operatorResponse = "Make sure that all relevant cables are connected to the Newport XPS motion controller properly and reboot this Assembly."
      autoAck          = false
      latched          = true
    }
    {
      name             = PRISM-p1Stepout
      description      = "Stepout of the stepper motor is detected in the P1 rotary stage"
      severityLevels   = [Warning, Major, Critical]
      location         = "IRIS Science ADC Assembly (IRIS.imager.adc)"
      alarmType        = Discrepancy
      probableCause    = "Wear-out of the retract stage mechanism."
      operatorResponse = "Report the issue to the instrument expert."
      autoAck          = false
      latched          = true
    }
    {
      name             = PRISM-p2Stepout
      description      = "Stepout of the stepper motor is detected in the P2 rotary stage"
      severityLevels   = [Warning, Major, Critical]
      location         = "IRIS Science ADC Assembly (IRIS.imager.adc)"
      alarmType        = Discrepancy
      probableCause    = "Wear-out of the retract stage mechanism."
      operatorResponse = "Report the issue to the instrument expert."
      autoAck          = false
      latched          = true
    }
    {
      name             = RETRACT-watchdog
      description      = "The RETRACT functional group is unresponsive"
      severityLevels   = [Major]
      location         = "IRIS Science ADC Assembly (IRIS.imager.adc)"
      alarmType        = System
      probableCause    = "Software bug"
      operatorResponse = "Restart the assembly and file a bug report."
      autoAck          = false
      latched          = true
    }
    {
      name             = RETRACT-incompatibleStageConfiguration
      description      = "The stage configuration for the retract stage in the Newport XPS motion controller is not compatible with this functional group."
      severityLevels   = [Warning, Major, Critical]
      location         = "IRIS Science ADC Assembly (IRIS.imager.adc)"
      alarmType        = System
      probableCause    = "Misconfiguration"
      operatorResponse = "Reconfigure the stage configuration in the Newport XPS motion controller and reboot it."
      autoAck          = false
      latched          = false
    }
    {
      name             = RETRACT-inconsistentSensorStatus
      description      = "Sensor status of the retract stage is inconsistent."
      severityLevels   = [Critical]
      location         = "IRIS Science ADC Assembly (IRIS.imager.adc)"
      alarmType        = BitPattern
      probableCause    = "Cable disconnection, or malfunction of sensors or the hall sensor readout electronics."
      operatorResponse = "Make sure that all relevant cables are connected to the Newport XPS motion controller properly and reboot this Assembly."
      autoAck          = false
      latched          = true
    }
    {
      name             = RETRACT-stepout
      description      = "Stepout of the stepper motor is detected in the retract stage"
      severityLevels   = [Warning, Major, Critical]
      location         = "IRIS Science ADC Assembly (IRIS.imager.adc)"
      alarmType        = Discrepancy
      probableCause    = "Wear-out of the retract stage mechanism."
      operatorResponse = "Report the issue to the instrument expert."
      autoAck          = false
      latched          = true
    }
  ]
}
