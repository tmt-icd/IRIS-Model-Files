subsystem = IRIS
component = imager.adc

publish {

  events = [
     {
        name = odgwShift
        description = """
IRIS publishes the expected ADC image shifts of the (up to 4) IRIS ODGW position demands


<em>
Discussion: The ADC will shift an image position in a manner that depends upon the current state of the ADC. Since the ODGWs are viewed through the science ADC, any telescope pointing shifts based on the sciShift event published by this assembly should also remove shifts in the ODGW positions. However, if the science ADC causes appreciable distortion, this published event can be used by the TCS to make small adjustments to the ODGW position demands to account for this distortion. The reference wavelength used to calculate the shift is tcs.cm.iris.imgCurAtmDispersion.referenceWavelength.
</em>
        """
        archive = true
        attributes = [
            {
                name = odgw1Shift
                description  = "2 element array holding x, y values (range TBD) in the FCRS<sub>IRIS-ROT</sub>, evaluated at the reference wavelength"
                type = array
                dimensions: [2]
                items = {
                    type = double
                    units = mm
                }
            }
            {
                name = odgw2Shift
                description  = "2 element array holding x, y values (range TBD) in the FCRS<sub>IRIS-ROT</sub>, evaluated at the reference wavelength"
                type = array
                dimensions: [2]
                items = {
                    type = double
                    units = mm
                }
            }
            {
                name = odgw3Shift
                description  = "2 element array holding x, y values (range TBD) in the FCRS<sub>IRIS-ROT</sub>, evaluated at the reference wavelength"
                type = array
                dimensions: [2]
                items = {
                    type = double
                    units = mm
                }
            }
            {
                name = odgw4Shift
                description  = "2 element array holding x, y values (range TBD) in the FCRS<sub>IRIS-ROT</sub>, evaluated at the reference wavelength"
                type = array
                dimensions: [2]
                items = {
                    type = double
                    units = mm
                }
            }
        ]
     }

    {
        name = sciShift
        description = """
IRIS publishes the expected ADC image shift of the scient target.

*Discussion: The ADC will shift an image position in a manner that depends upon the current state of the ADC. The estimated image shift (inferred from optical models) is sent from IRIS to the TCS so that the TCS can adjust the telescope pointing, thereby stabilizing the science target on the IRIS imager. The reference wavelength used to calculate the shift is tcs.cm.iris.imgCurAtmDispersion.referenceWavelength.*
        """
        archive = true
        attributes = [
            {
                name = shift
                description  = "2 element array holding x, y values (range TBD) in the FCRS<sub>IRIS-ROT</sub>, evaluated at the reference wavelength"
                type = array
                dimensions: [2]
                items = {
                    type = double
                    units = mm
                }
            }
            {
                name          = timestamp
                description   = "Time when valid (units and epoch are TBD)"
                units         = mjd
                type          = long
            }
        ]
    }

    {
        name = distortion
        description = """
IRIS publishes information related to the distortion that will be introduced by the Science ADC.

This event is published when the Science ADC is inserted into or retracted from the light path, and continuously published in the tracking mode.

All angles in this event are defined in the XY plane in the FCRS<sub>IRIS-ROT</sub>, and measured from the X axis in the counterclockwise direction looking towards the negative Z direction of the FCRS<sub>IRIR-ROT</sub>.

This event is intended to be subscribed by the AO system to correct the pupil displacement and the linear distortion introduced by this Science ADC.
"""
        archive = true
        attributes = [
            {
                name        = p1
                description = "Angle of the dispersion axis of the P1 prism pairs. $` \\alpha_1 `$"
                type        = double
                units       = degree
            }
            {
                name        = p2
                description = "Angle of the dispersion axis of the P2 prism pairs. $` \\alpha_2 `$"
                type        = double
                units       = degree
            }
            {
                name        = power
                description = "Power angle. $` \\alpha_{\\rm PW} = \\frac{ \\alpha_1 - \\alpha_2 }{2}`$"
                type        = double
                units       = degree
            }
            {
                name        = dispersion
                description = "Angle of the synthesized dispersion axis. $` \\alpha_{\\rm DA} = \\frac{ \\alpha_1 + \\alpha_2 }{2} `$"
                type        = double
                units       = degree
            }
            {
                name        = deployed
                description = "Indicates whether the Science ADC is in the light path. If this is false, the AO system should not correct the pupil displacement or the linear distortion."
                type        = boolean
            }
            {
                name          = timestamp
                description   = "Time when valid (units and epoch are TBD)"
                units         = mjd
                type          = long
            }
        ]
    }

    {
      name              = state
      description       = """Science ADC assembly overall state of prism and deploy mechanisms
      
      <em>
      Discussion: The onTarget attribute of this event should be used to determine if the both the prism and deploy mechanisms are working as intended during observations. If not, examine the PRISM_state and RETRACT_state values to determine the source of the problem.
      </em>
      """ 
      attributes = [
        {
          name          = cmd
          description   = "command state"
          enum          = [UNINITIALIZED,READY,BUSY,CONTINUOUS]
        }
        {
          name          = move
          description   = "At least one mechanism within the Science ADC (prism or deployment) is moving"
          enum          = [STOPPED,MOVING]
        }
        {
          name          = onTarget
          description   = "All of the Science ADC mechanisms (prism and deployment) are on target."
          type          = boolean
        }
      ]
    }
    {
      name = RETRACT-state
      description = "Standard assembly state as defiend in [Technical Document: Software Design Patterns for Device and Component Controllers (TMT.INS.TEC.16.079)](https://docushare.tmt.org/docushare/dsweb/Services/Document-57492) plus alpha."
      maxRate = 1
      archive = true
      attributes = [
        {
            name = cmd
            description  = "command state"
            enum = [UNINITIALIZED, READY, BUSY]
        }
        {
            name = move
            description  = "state of mechanisms that can move"
            enum = [TRUE, FALSE]
        }
        {
            name = selection
            description  = """
This state attribute indicates where the retract stage is. The meaning of each enum value is as follows:

<ul>
 <li><b>DEPLOYED</b>:  The ADC prisms are in the light path. It is considered deployed when the limit switch on the deployed position is engaged.</li>
 <li><b>RETRACTED</b>: The ADC prisms are retracted from the light path. It is considered retracted when the limit switch on the retracted position is engaged.</li>
 <li><b>UNKNOWN</b>:   This functional group falls into this state before datuming is completed or when an error is detected.</li>
 <li><b>INTERMEDIATE</b>: After the datuming is completed and if no limit switches are engaged, this functional group falls into this state, which indicates that the ADC prisms are somewhere between the deployed and retracted positions.</li>
</ul>
"""
            enum = [DEPLOYED, RETRACTED, UNKNOWN, INTERMEDIATE]
        }
        {
            name = debug
            description  = "debug level"
            enum = [DEBUG, INFO, WARN, ERROR]
        }
        {
            name = enabled
            description = "indicates whether this functional group is enabled"
            type = boolean
        }
        {
            name = interlock
            description = "indicates if an interlock is asserted by the Safety HCD"
            type = boolean
        }
        {
            name = inhibit
            description = "indicates if the inhibit signal to the underlying motion controller is active"
            type = boolean
        }
        {
            name = motion
            enum = [UNDATUMED, DATUMING, DATUMED.IN_POSITION, DATUMED.HALFWAY, MOVING.COARSE, MOVING.PAUSE, MOVING.PUSH, MOVING.RAW, ERROR]
            description  = """
<ul>
 <li><b>UNDATUMED</b>: The status of the mechanism is unknown in this state.  Typically, the stage is stopped, but it may be moving if the motion is on-going when this Assembly is booted.</li>
 <li><b>DATUMING</b>: The mechanism is searching a limit switch.</li>
 <li><b>DATUMED</b>: The stage is staying in a known position and the motor current is OFF.
  <ul>
    <li><b>IN_POSITION</b>: The stage is in either deployed or retracted position.</li>
    <li><b>HALFWAY</b>: The stage is somewhere between the deployed and retracted positions.</li>
   </ul>
 </li>
 <li><b>MOVING</b>: The stage is in motion and the current position is known.
  <ul>
   <li><b>COARSE</b>: The stage is in the coarse motion in either direction.</li>
   <li><b>PAUSE</b>: The stage is temporarily stopped before starting the push motion. The functional group will stay in this state very shortly.</li>
   <li><b>PUSH</b>: The stage is in the final slow push motion to search the limit switch.</li>
  </ul>
 <li><b>ERROR</b>: The status of the mechanism is unknown in this state. Typically, the stage is stopped in this state. But, it may be moving, for example, if the user operates the stage in an unusual way (e.g., directly trigger a command in the Web interface of the motion controller).</li>
 </li>
</ul>
"""
        }
        {
            name = errorMsg
            description = "Detailed error messages when 'error' is true. One string element per one active error."
            type = array
            dimensions = [16]
            items = {
              type = string
            }
        }
      ]
    }
    {
      name = RETRACT-cmdStatus
      description = "Standard command status of this functional group."
      archive = true
      ref = imager.shutter/events/cmdStatus
    }
    {
      name = RETRACT-stage
      description = "Current status of the retract stage."
      maxRate = 10
      archive = false
      attributes = [
        {
            name  = rawPosition
            description = """
The current raw position reported by the HCD.

This value does not represent the absolute position of the stage. This value will be published only for engineering purposes.
"""
            type  = double
            units = steps
        }
        {
            name  = rawVelocity
            description = """
The current velocity reported by the HCD.

This value does not represent the velocity of the stage, but the rotation velocity of the stepper motor. For example, when the stage is contacting the hard stop, the stage stays in the current position even if this value is non-zero.

This value will be published only for engineering purposes.
"""
            type  = double
            units = step/s
        }
        {
            name  = rawAcceleration
            description = """
The current acceleration reported by the HCD.

This value does not represent the acceleration of the stage, but the rotation acceleration of the stepper motor. For example, when the stage is contacting the hard stop, the stage cannot accelerate even if this value is non-zero.

This value will be published only for engineering purposes.
"""
            type  = double
            units = step/s<sup>2</sup>
        }
        {
            name  = position
            description = """
Estimated current angle from the limit switch of the retracted position. The reported angle may be different from the actual position if the stepper motor experiences misstep or there is misconfiguration.

It becomes NaN when undatumed or datuming.

This value will be published only for engineering purposes.
"""
            type     = double
            units    = deg
            minimum  = 0
            allowNaN = true
        }
        {
            name  = velocity
            description = """
Current commanded velocity of the stage.

This value becomes positive if the stage is moving in the direction of the deployed position.

This value will be published only for engineering purposes.
"""
            type  = double
            units = deg/s
        }
        {
            name  = acceleration
            description = """
Current commanded acceleration of the stage.

This value becomes positive if the stage is accelerating towards the deployed position.

This value will be published only for engineering purposes.
"""
            type  = double
            units = deg/s<sup>2</sup>
        }
        {
            name  = power
            description = "indicates if the stepper motor is powered or not."
            type  = boolean
        }
        {
            name = switches
            description  = "indicates the raw status (on or off) of switches (two limit switches and one position switch)"
            type        = struct
            attributes = [
              {
                name = "deployLimit"
                description = "limit switch of the deployed position"
                type = boolean
              }
              {
                name = "retractLimit"
                description = "limit switch of the retracted position"
                type = boolean
              }
              {
                name = "deployPosition"
                description = """position switch of the deployed position

NOTE: It is not guaranteed that the prisms are in the light path even if this attribute is true.
"""
                type = boolean
              }
            ]
        }
      ]
    }
  ]

  alarms = [
    {
      name             = PRISM-watchdog
      description      = "The PRISM functional group is unresponsive"
      severityLevels   = [Major]
      location         = "IRIS Science ADC Assembly (IRIS.imager.adc)"
      alarmType        = System
      probableCause    = "Software bug"
      operatorResponse = "Restart the assembly and file a bug report."
      autoAck          = false
      latched          = true
    }
    {
      name             = PRISM-incompatibleStageConfiguration
      description      = "The stage configuration in the Newport XPS motion controller is not compatible with this functional group."
      severityLevels   = [Warning, Major, Critical]
      location         = "IRIS Science ADC Assembly (IRIS.imager.adc)"
      alarmType        = System
      probableCause    = "Misconfiguration"
      operatorResponse = "Reconfigure the stage configuration in the Newport XPS motion controller and reboot it."
      autoAck          = false
      latched          = false
    }
    {
      name             = RETRACT-watchdog
      description      = "The RETRACT functional group is unresponsive"
      severityLevels   = [Major]
      location         = "IRIS Science ADC Assembly (IRIS.imager.adc)"
      alarmType        = System
      probableCause    = "Software bug"
      operatorResponse = "Restart the assembly and file a bug report."
      autoAck          = false
      latched          = true
    }
    {
      name             = RETRACT-incompatibleStageConfiguration
      description      = "The stage configuration in the Newport XPS motion controller is not compatible with this functional group."
      severityLevels   = [Warning, Major, Critical]
      location         = "IRIS Science ADC Assembly (IRIS.imager.adc)"
      alarmType        = System
      probableCause    = "Misconfiguration"
      operatorResponse = "Reconfigure the stage configuration in the Newport XPS motion controller and reboot it."
      autoAck          = false
      latched          = false
    }
    {
      name             = RETRACT-inconsistentSwitchStatus
      description      = "switch status is inconsistent"
      severityLevels   = [Warning, Critical]
      location         = "IRIS Science ADC Assembly (IRIS.imager.adc)"
      alarmType        = BitPattern
      probableCause    = "Cable disconnection or malfunction of switches"
      operatorResponse = "Make sure that all relevant cables are connected to the Newport XPS motion controller properly and reboot this Assembly."
      autoAck          = false
      latched          = true
    }
  ]
}
