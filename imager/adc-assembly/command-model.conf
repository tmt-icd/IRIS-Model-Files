subsystem = IRIS
component = imager.adc

receive = [
    {
        name = RETRACT-init
        description = """
This command initializes the RETRACT functional group and reloads the configuration files. It does not trigger any motion or initiate any action on the hardware.

If the stage position is halfway, the datum may be lost as a result of re-initialization.
"""
        completionType = longRunning
    }
    {
        name = RETRACT-datum
        description = "Start datuming the retract stage."
        completionType = longRunning
        preconditions  = ["RETRACT-state.enabled == true"]
        postconditions = [
                          "RETRACT-state.motion == IN_POSITION",
                          "RETRACT-state.selection == RETRACTED",
                          "RETRACT-stage.power == false"
                         ]
    }
    {
        name = RETRACT-select
        description = "This command inserts the Science ADC in the science light path or retracts it."
        requiredArgs = [target]
        args = [
            {
                name = target
                description = "Target position."
                enum = [DEPLOY, RETRACT]
            }
        ]
        completionType = longRunning
        preconditions  = [
                           "RETRACT-state.motion == DATUMED.IN_POSITION || RETRACT-state.motion == DATUMED.HALFWAY",
                           "RETRACT-state.enabled == true"
                          ]
        postconditions = [
                          "RETRACT-state.motion == IN_POSITION",
                          "RETRACT-state.selection == DEPLOYED || RETRACT-state.selection == RETRACTED",
                          "RETRACT-stage.power == false"
                         ]
    }
    {
        name = RETRACT-move
        description = "This command moves the retract stage to an arbitrary position relative to the current position."
        requiredArgs = [target]
        args = [
            {
                name = target
                description = "Target position relative to the current position."
                type = double
                units = step
            }
            {
                name = velocity
                description = "Motion velocity."
                type = double
                units = step/s
                exclusiveMinimum = 0
                default = RETRACT-RawMotionVelocity
            }
            {
                name = acceleration
                description = "Motion acceleration."
                type = double
                units = step/s<sup>2</sup>
                exclusiveMinimum = 0
                default = RETRACT-RawMotionAcceleration
            }
            {
                name = minimumJerkTime
                description = "Minimum jerk time."
                type = double
                units = s
                default = RETRACT-RawMinJerkTime
            }
            {
                name = maximumJerkTime
                description = "Maximum jerk time."
                type = double
                units = s
                default = RETRACT-RawMaxJerkTime
            }
        ]
        completionType = longRunning
        role = "eng"
        preconditions  = [
                           "RETRACT-state.motion == DATUMED:IN_POSITION || RETRACT-state.motion == DATUMED.HALFWAY || RETRACT-state.motion == MOVING:RAW",
                           "RETRACT-state.enabled == true"
                         ]
        postconditions = [
                          "RETRACT-state.motion == IN_POSITION || RETRACT-state.motion == HALFWAY",
                          "RETRACT-stage.power == false"
                          ]
    }
    {
        name = RETRACT-disable
        description = """
This command disables this functional group. Any commands that trigger a motion or turn on the motor current will be rejected when disabled.

This command is expected to be called before starting a cool-down or warm-up procedure.
"""
        completionType = immediate
        preconditions  = [
                          "RETRACT-state.motion  == DATUMED:IN_POSITION || RETRACT-state.motion == DATUMED.HALFWAY",
                          "RETRACT-state.enabled == true"
                         ]
        postconditions = ["RETRACT-state.enabled == false"]
    }
    {
        name = RETRACT-enable
        description = """
This command enables this functional group.

This command is expected to be called after the cool-down or warm-up procedure is completed.
"""
        completionType = immediate
        preconditions  = ["RETRACT-state.enabled == false"]
        postconditions = ["RETRACT-state.enabled == true"]
    }
    {
        name = RETRACT-park
        description = "This command does nothing."
        completionType = immediate
    }
    {
        name = RETRACT-stop
        description = "Stop the motion of the retract stage and turn off the motor power."
        completionType = longRunning
        preconditions  = ["RETRACT-state.motion == DATUMING || RETRACT-state.motion == MOVING.* || RETRACT-state.motion == ERROR"]
        postconditions = [
                           "RETRACT-state.motion == UNDATUMED || RETRACT-state.motion == DATUMED.IN_POSITION || RETRACT-state.motion == DATUMED.HALFWAY || RETRACT-state.motion == ERROR",
                           "RETRACT-stage.power == false"
                          ]
    }
    {
        name = RETRACT-test
        description = "This command executes a self-test. The actual action to be taken is TBD. This command never drives the retract stage."
        completionType = immediate
        role = "eng"
    }
    {
        name = RETRACT-debug
        description = "This command sets the current debug level."
        completionType = immediate
        role = "eng"
    }

    {
        name = PRISM_INIT
        description = """
This command causes PRISM functional group to initialize its variables, read configuration, and verify dependencies.  It prepares this functional group internally such that it is available to communicate with outside processes and begin managing the stages.  It does not cause any movement or initiate any action on the hardware but, it may validate connections and hardware presence before completing.  It may also initialize per-axis configuration of the underlying Galil HCD.

This command can be invoked only when none of the rotary stages is in motion. All commands will be rejected during the initialization. 

Initialization can fail for various reasons including HCD communications failure, hardware failure, or invalid configurations.  In this case, the command state will report an error.


Command type: request
"""
    }
    {
        name = PRISM_TEST
        description = """
This command executes a self-test.  Actual action to be taken is TBD.

This command never drives any stages.

This command can be invoked only when none of the rotary stages is in motion. All commands will be rejected during the test.

Command type: request
"""
    }
    {
        name = PRISM_DATUM
        description = """
Perform homing of the rotary stages and reset the stepper motor counters to accurately and precisely position the stages. Then, the rotary stages will be moved to the zero power and zero angle position.

This command can be invoked only when none of the rotary stages is in motion. All commands except “PRISM_stop” will be rejected during the datum.

In the event of an error or failure to index, datum will return an error response, the command state will be set to error, and the movement state will be un-indexed and the position will be reported as unknown.

Command type: submit
"""
    }
    {
        name = PRISM_FOLLOW
        description = """
Transitions this assembly into the continuous state where it performs tracking motion continuously based on the event stream from TCS.
This command can be invoked only when none of the rotary stages is in motion. All commands except “stop” will be rejected during the execution of this command.

Command type: submit
"""
    }
    {
        name = PRISM_LOCK
        description = """
This command locks this functional grup. The commands that trigger any motion will be rejected when locked.

This command is expected to be called before starting the cool-down or warm-up procedure.

Command type: request
"""
    }
    {
        name = PRISM_UNLOCK
        description = """
This command unlocks this functional group.

This command is expected to be called after the cool-down or warm-up procedure is completed.

Command type: request
"""
    }
    {
        name = PRISM_PARK
        description = """
This command basically does nothing. The angles of prisms can be placed anywhere when the instrument is not in use.

It is possible to rotate the rotary stages to the most commonly used position in response to this command. However, from the view point of the mechanical lifetime (the more you move the stage, the more chances the stage has to encounter a misstep problem), it is better not to move the stages unnecessarily.

Command type: submit
"""
    }
    {
        name = PRISM_MOVE
        description = """
This command rotates the rotary stages to the specified position. It is expected that this command will not be used in the operation. This is mostly for engineering purposes.

This command can be invoked only when none of the rotary stages is in motion. All commands except “PRISM_stop” will be rejected during the execution of this command.

Command type: submit
"""
        args = [
            {
                name = prism1_deg
                description = """
Upper prism absolute angle or relative amount from the current angle (depends on prism1_mode).

The range of the absolute angle is defined by _thetaConf.softwareLimits_. If the position specified by this argument exceeds the range, this command will be rejected.
"""
                type = float
                default = 0
            }
            {
                name = prism1_mode
                description = "This argument specifies if the given angle in prism1_dig is absolute angle or relative amount."
                enum = [ABSOLUTE, RELATIVE]
                default = RELATIVE
            }
            {
                name = prism2_deg
                description = """
Lower prism absolute angle or relative amount from the current angle (depends on prism2_mode).

The range of the absolute angle is defined by _thetaConf.softwareLimits_. If the position specified by this argument exceeds the range, this command will be rejected.
"""
                type = float
                default = 0
            }
            {
                name = prism2_mode
                description = "This argument specifies if the given angle in prism2_deg is absolute angle or relative amount."
                enum = [ABSOLUTE, RELATIVE]
                default = RELATIVE
            }
        ]
    }
    {
        name = PRISM_STOP
        description = """
Stop rotation of all rotary stages. This command is also used to stop the tracking motion.

Command type: submit
"""
    }
    {
        name = PRISM_DEBUG
        description = """
This will set the current debug level.  This is for debugging purposes and allows the user to change the level of logging for debugging purposes.

Command type: request
"""
    }
    {
        name = shutdown
        description = "Stop this Assembly. It does not send this command down to the underlying HCDs. The on-going motion or exposure may continue after shutdown."
        completionType = longRunning
    }
]
